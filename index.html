<!doctype html>
<html>
<head>

<!-- https://github.com/rpj/rhp-client-example -->

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<style type="text/css">
BODY {
    background-color: #111222;
    color: #eeefff;
}

@media screen and (min-width: 960px) {
  BODY { 
    font-size: 125%;
  }

  .plot {
    width: 400px;
    height: 250px;
  }
}

@media screen and (max-width: 960px) and (min-width: 640px) {
  BODY { 
    font-size: 150%;
  }

  .plot {
    width: 400px;
    height: 250px;
  }
}

@media screen and (max-width: 640px) {
  BODY { 
    font-size: 200%;
  }

  .plot {
    width: 350px;
    height: 250px;
  }
}

.base {
  margin: 20px;
}

.base h1 {
  display: inline;
  padding: 10px;
  font-family: "Lucida Console", Monaco, monospace;
}

.base span {
  font-size: 50%;
  font-style: italic;
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(min(200px, 100%), 1fr));
  grid-gap: 1rem;
}

</style>

<script>
const loginExpiry = 24; // hours
const windowSize = 150;

const plotConfig = {
  displayModeBar: false, 
  scrollZoom: false, 
  responsive: true
};

const _ = {
  id: document.getElementById.bind(document),
  new: document.createElement.bind(document),
  r: (v, f = 100, c = 4) => (Math.round(v * f) / f).toPrecision(c),
  dc: (eId) => {
    let deepClone = _.id(eId).cloneNode(true);
    deepClone.removeAttribute('id');
    return deepClone;
  }
};

const cookies = () => document.cookie.replace(/\s+/g, '').split(';')
  .map(x => x.split('=')).reduce((a, x) => {
    a[x[0]] = x[1];
    return a;
  }, {});

async function subscribe(channel, onMessage, onClose) {
    let opts = {
      headers: { 'Authorization': `Basic ${cookies().auth.replace(/!/g, '=')}` }
    };

    let otp = await fetch(`http://${window.location.host}:56545/sub/${channel}`, opts);

    if (otp.status !== 200) {
      console.log('sub req failed');
      console.log(otp);
      return;
    }

    let ws = new WebSocket(`ws://${window.location.host}:56545/ws/sub?${(await otp.text())}`);
    ws.addEventListener('message', (ev) => onMessage(JSON.parse(JSON.parse(ev.data))));
    ws.addEventListener('close', onClose);
}

function newSubscribeElement(channel, parentId, onMessage) {
  let intoEle = _.dc('gridtmpl');
  intoEle.id = `nSE_grid_${channel}`;
  _.id(parentId).append(intoEle);
  
  subscribe(channel, (jpData) => onMessage(intoEle, jpData), () => {
    console.log(`channel ${channel} closed, removing associated element...`);
    _.id(parentId).removeChild(intoEle);
  });

  return intoEle;
}

function addSPS30() {
  let pm25ele = _.dc('basictmpl');
  let pm10ele = _.dc('basictmpl');

  let firstTs;
  let pm25PlotDiv = _.new('div');
  pm25PlotDiv.id = 'pm25Plot';
  pm25PlotDiv.className = 'plot';

  let pm25PlotData = {
    x: [],
    y: [],
    type: 'scatter',
    name: 'PM 2.5'
  };

  let pm25PlotLayout = {
    title: { 
        text: "PM 2.5",
        font: {
            family: '"Lucida Console", Monaco, monospace',
            color: '#eeefff'
        }
    },
    datarevision: 0,
    margin: { l: 50, r: 25, b: 25, t: 50, pad: 4 },
    plot_bgcolor: '#444555',
    paper_bgcolor: '#111222',
    colorway: ['#eeefff'],
    xaxis: { 
        tickcolor: '#eeefff',
        tickfont: { 
            family: '"Lucida Console", Monaco, monospace',
            color: '#eeefff'
        } 
    },
    yaxis: { 
        tickcolor: '#eeefff',
        tickfont: { 
            family: '"Lucida Console", Monaco, monospace',
            color: '#eeefff'
        } 
    }
  };

  let pm25PlotDataSpec = [pm25PlotData];
  
  pm25ele.children.item(1).innerHTML = 'PM 2.5';
  pm10ele.children.item(1).innerHTML = 'NC 2.5';

  let spsEle = newSubscribeElement('zed:sensor:SPS30', 'div_one', (ele, jpData) => {
    const r25 = _.r(jpData.value.mc_2p5, 100, 3);

    pm25ele.children.item(0).innerHTML = r25;
    pm10ele.children.item(0).innerHTML = _.r(jpData.value.nc_2p5, 10, 3);

    if (firstTs === undefined) {
      firstTs = jpData.ts;
    }
    
    if (pm25PlotData.x.length === windowSize) {
      pm25PlotData.x.shift();
      pm25PlotData.y.shift();
    }

    pm25PlotData.x.push(jpData.ts - firstTs);
    pm25PlotData.y.push(r25);
    pm25PlotLayout.datarevision += 1;

    if (Math.max(...pm25PlotData.y) - Math.min(...pm25PlotData.y) > 100) {
      pm25PlotLayout.yaxis.type = 'log';
    } else if ('yaxis' in pm25PlotLayout) {
      pm25PlotLayout.yaxis.type = 'linear';
    }

    Plotly.react('pm25Plot', pm25PlotDataSpec, pm25PlotLayout, plotConfig); 
  });

  spsEle.append(pm25ele);
  spsEle.append(pm25PlotDiv);
  Plotly.newPlot('pm25Plot', pm25PlotDataSpec, pm25PlotLayout, plotConfig);
  spsEle.append(_.new('div'));
  spsEle.append(pm10ele);
}

function addBME280() {
  let tempEle = _.dc('basictmpl'); 
  let humdEle = _.dc('basictmpl');
  let presEle = _.dc('basictmpl');
  let timeEle = _.dc('basictmpl');

  tempEle.children.item(1).innerHTML = 'Outdoor';
  humdEle.children.item(1).innerHTML = 'Rel. Humidity';
  presEle.children.item(1).innerHTML = 'Pressure';
  timeEle.children.item(1).innerHTML = '';

  let thpEle = newSubscribeElement('zero:sensor:BME280', 'div_one', (ele, jpData) => {
    tempEle.children.item(0).innerHTML = `${_.r(jpData.value.temperature, 10, 3)}&deg;F`;
    humdEle.children.item(0).innerHTML = `${_.r(jpData.value.humidity, 10, 3)}%`;
    presEle.children.item(0).innerHTML = _.r(jpData.value.pressure, 1);
    timeEle.children.item(0).innerHTML = new Date(jpData.ts * 1e3).toLocaleTimeString().replace('PM', '').replace('AM', '');
  });

  thpEle.append(tempEle);
  thpEle.append(humdEle);
  thpEle.append(presEle);
  thpEle.append(timeEle);
}

async function loadPage() {
  let kvCookies = cookies();
  let authBox = _.id('authbox');

  if (!('auth' in kvCookies)) {
    _.id("div_one").append(authBox);
    authBox.style.display = "block";
  } else {
    authBox.parentElement.removeChild(authBox);
    addBME280();
    addSPS30();
  }
}

async function auth() {
  let lExp = new Date(Date.now() + (loginExpiry * 3600 * 1e3)).toGMTString()
  let authEnc = window.btoa(`${_.id("in_u").value}:${_.id("in_p").value}`).replace(/=/g, '!');
  document.cookie = `auth=${authEnc}; Expires=${lExp}`;
  loadPage();
}

window.onload = async () => {
  _.id('authbut').addEventListener('click', () => auth());
  loadPage();
};
</script>
</head>

<body>
<div id="div_one">
</div>

<div id="authbox" style="display: none">
<form>
username: <input type="text" id="in_u" /><br/>
password: <input type="password" id="in_p" /><br/>
<input id="authbut" type="submit" value="authorize"/>
</form>
</div>

<div id="tmplcont" style="display: none">
<div class="grid" id="gridtmpl"></div>
<div class="base" id="basictmpl">
<h1></h1>
<span></span>
</div>
</div>

</body>
</html>
